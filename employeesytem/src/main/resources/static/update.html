<!DOCTYPE html>
<html>
<head>
    <title>Update Employee</title>
    <style>
        .error { color: red; margin-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
    </style>
    <script src="validation.js"></script>
</head>
<body>

<a href="/index.html">Home</a>

<h2>Update Employee</h2>

<div id="generalError" class="error"></div>

<form onsubmit="updateEmployee(event)">
    <div class="form-group">
        <label for="id">Employee ID:</label>
        <input type="number" id="id" onblur="fetchEmployee()" required />
        <div id="idError" class="error"></div>
    </div>
    <div class="form-group">
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" required />
        <div id="firstNameError" class="error"></div>
    </div>
    <div class="form-group">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" required />
        <div id="lastNameError" class="error"></div>
    </div>
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" required />
        <div id="emailError" class="error"></div>
    </div>
    <div class="form-group">
        <label for="department">Department:</label>
        <select id="department" required>
            <option value="">-- Select Department --</option>
            <option value="HR">HR</option>
            <option value="IT">IT</option>
            <option value="MARKETING">Marketing</option>
            <option value="SALES">Sales</option>
            <option value="FINANCE">Finance</option>
        </select>
        <div id="departmentError" class="error"></div>
    </div>
    <div class="form-group">
        <label for="salary">Salary:</label>
        <input type="number" id="salary" required min="1" step="0.01" />
        <div id="salaryError" class="error"></div>
    </div>

    <button type="submit">Update</button>
</form>

<script>
    async function fetchEmployee() {
            resetErrors();
            const id = document.getElementById("id").value;
            if (!id) return;

            try {
                const response = await fetch(`/api/v1/employees/${id}`);

                if (!response.ok) {
                    document.getElementById("generalError").textContent = `Employee with ID ${id} not found.`;
                    // Clear all fields if not found
                    document.getElementById("firstName").value = "";
                    document.getElementById("lastName").value = "";
                    document.getElementById("email").value = "";
                    document.getElementById("department").value = "";
                    document.getElementById("salary").value = "";
                    return;
                }

                const emp = await response.json();

                // Auto-fill the form, including the select field
                document.getElementById("id").value = emp.id;
                document.getElementById("firstName").value = emp.firstName;
                document.getElementById("lastName").value = emp.lastName;
                document.getElementById("email").value = emp.email;
                document.getElementById("department").value = emp.department;
                document.getElementById("salary").value = emp.salary;
                document.getElementById("generalError").textContent = "";
            } catch (err) {
                 document.getElementById("generalError").textContent = "Network error during fetch.";
            }
    }

    async function updateEmployee(e) {
        e.preventDefault();
        document.getElementById("generalError").textContent = "";
        resetErrors(); // Call reset from external file

        const id = document.getElementById("id").value;

        const employee = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            department: document.getElementById("department").value,
            salary: parseFloat(document.getElementById("salary").value)
        };

        // 1. Run client-side validation
        if (!validateEmployee(employee)) {
            return; // Stop submission if client validation fails
        }

        try {
            const res = await fetch(`/api/v1/employees/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(employee)
            });

            if (res.ok) {
                alert("Employee updated successfully!");
                window.location.href = "/index.html";
            } else {
                // 2. Use external handler for all expected errors
                const handled = await handleBackendValidationErrors(res);
                if (!handled) {
                     document.getElementById("generalError").textContent = `Error: ${res.statusText} (${res.status})`;
                }
            }
        } catch (err) {
            document.getElementById("generalError").textContent = "Network error or server unreachable.";
        }
    }
</script>

</body>
</html>
